# 为不方便自定义 ip 设备配置自动旁路由网关

在使用 `dnsmasq` 作为 DHCP 服务器时，可以通过配置为特定设备分配不同的网关（即旁路由）。以下是实现步骤：

### 1. 确定设备的 MAC 地址

首先，获取目标设备的 MAC 地址。

### 2. 修改 `dnsmasq` 配置文件

编辑 `/etc/dnsmasq.conf` 文件，添加如下配置：

```bash
# 为特定设备分配固定 IP 和网关
dhcp-host=XX:XX:XX:XX:XX:XX,192.168.1.100,set:custom_gw
dhcp-option=tag:custom_gw,3,192.168.1.254
```

- `XX:XX:XX:XX:XX:XX` 替换为目标设备的 MAC 地址。
- `192.168.1.100` 是为该设备分配的固定 IP。
- `192.168.1.254` 是旁路由的 IP 地址。

### 3. 重启 `dnsmasq`

保存并退出后，重启 `dnsmasq` 服务：

```bash
sudo systemctl restart dnsmasq
```

### 4. 验证配置

确保目标设备获取到指定的 IP 和网关。

## 注意事项

- 确保旁路由已正确配置并允许流量通过。
- 如果网络中有其他 DHCP 服务器，需确保它们不会干扰 `dnsmasq` 的分配。

通过这些步骤，你可以为特定设备指定旁路由作为网关。

在 `dnsmasq` 的配置中，`3` 是 DHCP 选项中的一个编号，表示 **默认网关（Default Gateway）**。DHCP 选项是 DHCP 协议中用于传递网络配置参数的标准化方式，每个选项都有一个编号，`3` 是专门用于指定网关的选项。

### 具体解释

在你的配置中：

```bash
dhcp-option=tag:custom_gw,3,192.168.1.254
```

- `tag:custom_gw`：表示这个选项仅适用于标记为 `custom_gw` 的设备（通过 `dhcp-host` 设置）。
- `3`：表示 DHCP 选项中的“默认网关”。
- `192.168.1.254`：是你要分配给设备的网关地址（旁路由的 IP 地址）。

### 常见的 DHCP 选项编号

以下是一些常见的 DHCP 选项编号及其含义：

- `1`：子网掩码（Subnet Mask）
- `3`：默认网关（Router）
- `6`：DNS 服务器（Domain Name Server）
- `15`：域名（Domain Name）
- `42`：NTP 服务器（Network Time Protocol Server）

### 为什么需要指定 `3`？

在 DHCP 协议中，客户端（设备）会从服务器获取一系列网络配置参数，包括 IP 地址、子网掩码、网关、DNS 等。通过指定 `3`，你明确告诉 `dnsmasq` 将 `192.168.1.254` 作为网关分配给特定的设备。

### 总结

`3` 是 DHCP 选项中的默认网关编号，用于指定设备的网关地址。在你的配置中，`3` 的作用是将旁路由的 IP 地址（`192.168.1.254`）作为网关分配给特定的设备。

## 题外

### 限制特定设备获取 ipv6

在当今这个高速发展的数字时代，网络配置成了每个家庭和企业必须面对的挑战之一。网络设置的优化不仅可以提高效率，还能确保安全性和控制性。其中，一个常见问题是如何处理 IPv6 与 IPv4 的共存问题，尤其是在设置旁路网关的情况下。本文将深入探讨这一问题，并提供一些实用的解决方案。

### 前言

在开始之前，让我们先明确一个概念：旁路网关。旁路网关是一种网络架构设计，它允许数据流在主路由和备用路由之间进行选择性地传输。这种设计在某些情况下非常有用，比如流量经过旁路网关处理后，可以实现科学上网。然而，在实际应用中，我们发现了一个问题：即使 DNS 解析到了 IPv6 地址，数据流仍然会通过主路由传输。这不仅影响了网络的灵活性，还可能对网络性能造成负面影响。
问题的根源。

要理解这一现象，我们需要先了解 DNS 解析和 IPv6 的基础知识。DNS（域名系统）是互联网中用于将域名转换为 IP 地址的系统。而 IPv6 是为了解决 IPv4 地址耗尽问题而设计的下一代互联网协议。当 DNS 解析到一个 IPv6 地址时，理论上应该通过支持 IPv6 的路径进行数据传输。然而，IPv6 地址一般都是由主路由分配，所以流量没有经过旁路网关。

### 解决方案的探讨

为了解决这个问题，人们提出了多种方法。一种常见的做法是通过配置 DNS 服务器，使其不解析 IPv6 地址。这样，即使 DNS 返回的是 IPv6 地址，由于路由器不支持，数据流将被迫通过 IPv4 路径。然而，这种方法总觉得不完美。所以特殊设备单独关闭 IPv6 就是我理想的解决方法。但是，许多现代游戏机不支持单独关闭 IPv6，这就需要我们寻找其他解决方案。
我的解决方案。

经过一番研究和实验，我发现了一个更为直接的方法，那就是使用 ip6tables 工具。ip6tables 是 Linux 系统中用于 IPv6 包过滤的工具，功能类似于 IPv4 的 iptables。通过在路由器端配置 ip6tables 规则，我们可以有效地限制特定设备获取 IPv6 地址。

具体来说，我使用了以下两条命令：

```sh
ip6tables -t filter -A INPUT -m mac --mac-source 2C:26:17:E6:AB:16 -j DROP
ip6tables -t filter -A FORWARD -m mac --mac-source 2C:26:17:E6:AB:16 -j DROP
```

这两条命令的作用是，在数据包过滤表的输入和转发链中，丢弃所有来自特定 MAC 地址的 IPv6 数据包。这样一来，即使 DNS 解析到了 IPv6 地址，特定设备也无法获取到 IPv6 连接，从而确保了网络流量按照我们预定的路径流动，而且这么配置后设备重启后由于无法访问路由器的通告服务直接就没有 IPv6 地址了。

### 结语

网络配置是一个复杂而微妙的过程，需要我们对各种网络工具和协议有深入的了解。通过上述方法，我们不仅可以解决 IPv6 与旁路网关共存的问题，还能提高网络的稳定性和安全性。希望本文提供的解决方案能够帮助到那些在网络配置中遇到类似问题的读者。记住，网络世界充满了无限可能，而我们通过不断学习和实践，可以更好地驾驭它。
